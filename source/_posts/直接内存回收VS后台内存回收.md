---
title: 当内存满的时，操作系统会做什么？
date: 2023-03-09 14:28:31
tags: os
categories: os
---



当应用程序通过malloc申请内存时，实际上申请的是虚拟内存，当CPU去访问具体的虚拟内存时，如果虚拟内存没有被映射成物理内存，此时CPU会产生`缺页中断`，然后应用程序会从用户态转换到内核态，并调用缺页终端处理函数，缺页中断处理函数会查看是否有未被使用的物理内存，如果有，将直接映射到页表，如果没有，则进行内存回收机制。

# 后台内存回收（kswapd）

后台内存回收是指在物理内存紧张的情况下，系统会启动内存回收机制来释放已分配但未使用的内存空间，以满足系统或进程的内存需求。后台内存回收主要由一个内核线程 `kswapd` 负责，它会定期扫描内存中的页面列表，并将不活跃的页面换出到交换空间中，以释放内存空间。

后台内存回收的过程是`异步`的，即 kswapd 内核线程会在后台执行内存回收操作，不会阻塞正在执行的进程。当系统内存使用率达到一定的阈值时，kswapd 线程会被唤醒，开始执行内存回收操作。kswapd 线程会首先尝试回收已经换出到交换空间中的页面，然后再回收未使用的内存页。

后台内存回收的速度取决于系统的内存压力和 kswapd 线程的优先级，系统会根据内存使用情况动态调整 kswapd 线程的优先级和内存回收策略，以保证系统的可用内存达到一定的水平。当系统内存使用率下降时，kswapd 线程会自动减少内存回收操作，直到内存使用率下降到一定的水平。

需要注意的是，后台内存回收虽然不会阻塞进程的执行，但会占用一定的系统资源，可能会对系统的性能产生一定的影响。因此，在设计和编写应用程序时，应该尽可能地减少内存使用，避免内存泄漏和内存过度申请，以提高系统的可靠性和性能。同时，系统管理员也应该及时调整系统参数，增加系统内存容量，以避免出现内存紧张的情况。

# 直接内存回收

直接内存回收是指当系统中可用内存不足以满足进程所需内存时，系统会启动内存回收机制来释放已分配但未使用的内存空间，以满足进程的内存需求。在直接内存回收期间，系统会直接回收已分配但未使用的内存页，以及通过页面换入机制换出的内存页，以获取更多的空闲内存。

直接内存回收的过程是`同步`的，即当系统开始回收内存时，会`阻塞`进程的执行，直到回收完成。这是因为直接内存回收需要遍历整个进程地址空间，找到未使用的内存页，并将这些内存页释放回内存池中，这个过程需要较长时间，会导致进程的执行暂停，直到内存回收完成。

在直接内存回收期间，系统会按照一定的策略来选择需要回收的内存页。例如，系统会优先回收长时间未使用的内存页，或者已被换出的内存页，以尽可能地减少对进程的影响。

值得注意的是，直接内存回收只是系统内存管理的一种应急措施，应该尽量避免其发生。因此，在编写应用程序时，应该尽可能地避免内存泄漏或内存过度申请，以免造成系统性能下降或应用程序崩溃等问题。同时，系统管理员也应该及时调整系统参数，增加系统内存容量，以提高系统的可靠性和性能。

---

当如上方式回收内存还是无法满足使用时，内核将会触发OOM。

# OOM（Out of Memory）

OOM Killer机制会根据算法找到一个物理内存占用高的内存，然后将其杀死，如果还不够则继续杀，其实就是大家手机上的杀后台策略。
