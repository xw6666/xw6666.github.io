---
title: 结构体空间大小计算方法
date: 2022-03-31 23:29:30
tags: cpp
categories: cpp
---

## 共用体空间大小计算

每个成员变量都从同一个地址开始存储，共用一块空间
假设num从0号地址开始存放，int四个字节，即0,1,2,3四个地址存放的是int
name是5个连续的char变量，也从0开始存放占用0，1，2，3，4五个地址空间
s占用0地址空间
共有体的大小（单位字节）一定是最大成员变量类型大小的整数倍
在以下结构体中，占空间最大的类型是int(char[5]本质是5个char)，所以结构体大小一定是4的整数倍
即4，8，12，16..由于4个字节不够装下char name[5]，所以这个结构体大小是8字节

```cpp
union stu1
{
	int num;
	char name[5];
	char s;
};
```



```cpp
//根据上述分析，这个结构体字节大小只能是8,16,24...所以结构体大小是16字节
union stu3
{
	double num;
	char name[9];
	char s;
};
```





## 结构体对齐规则

1. 第一个成员在与结构体变量偏移量为0的地址处。
2. 其他成员变量要对齐到某个数字(对齐数)的整数倍的地址处。
3. 结构体总大小为最大对齐数（每个成员变量都有一个对齐数）的整数倍。
4. 如果嵌套了结构体的情况，嵌套的结构体对齐到自己的最大对齐数的整数倍处，结构体的总大小就是所有最大对齐数（含嵌套结构体的对齐数）的整数倍。

对齐数 = min(编译器默认对齐数，该成员类型大小)

```cpp
struct stu2
{
	int num;
	char name[5];
	char s;
};
```

我们来具体分析一下 上述结构体：

首先假设num从0地址处开始存放，所以占用0,1,2,3四个地址(第一个成员在与结构体变量偏移量为0的地址处)，然后name本质上是连续的char类型，char的对齐数是 min(8, sizeof(char)) = 1，所以地址4是可以放char的，因为4是1的倍数，于是4到8这5个地址存储 name[5]，之后s的对齐数还是1，所以9号地址放s，这时候我们一共使用了10个地址(0到9)，根据结构体总大小为最大对齐数的整数倍，这里的最大对齐数是int的对齐数是4,所以一定要是4的整数倍，所以10字节不是我们的答案，12才是。



再来一个例子：

```cpp
struct stu2
{
	char name;
	int num;
	char s;
};
```

name假设放0地址数，num的对齐数是min(8,sizeof(int)) = 4,所以num从4号开始放，占用4,5,6,7

最后char占用8号地址，一共使用9个字节空间(0到8),不是4的整数倍，所以补到12个字节空间，结构体总大小为12字节。



## 自己设置对齐数

通过#pragma pack()宏，可以实现自己设置对齐数

例如：

```cpp
# pragma pack(1)   //设置对齐数为1
struct stu2
{
	char name;
	int num;
	char s;
};
```

这时候所有的成员大小都是1的倍数，所以直接顺序存放，name假设放0地址处，num就放1，2，3，4，s放5，一共6个字节，是对齐数1的倍数，不用额外空间。
